class g{constructor(t,n,e,a){this.form=t,this.orderHandler=n,this.data=e,this.paymentArgs=(e==null?void 0:e.payment_args)||{},this.intent=(e==null?void 0:e.intent)||{},this.paymentLoader=a,this.currentOrderData=null,this.$t=this.translate.bind(this)}translate(t){var e;return(((e=window.fct_paddle_data)==null?void 0:e.translations)||{})[t]||t}init(){const t=document.querySelector(".fluent-cart-checkout_embed_payment_container_paddle");if(!t){console.error("Paddle container not found");return}t.innerHTML="";const n=this.form.querySelector(".fluent_cart_payment_methods");n&&(n.style.display="none"),this.initializePaddleSDK().then(()=>{this.createPaddleButton(t)}).catch(e=>{console.error("Paddle initialization error:",e),this.displayErrorMessage(t,e.message)})}async initializePaddleSDK(){var e,a;if(typeof Paddle>"u")throw new Error(this.$t("Paddle SDK is not loaded. Please ensure the Paddle script is included."));const t=(e=this.paymentArgs)==null?void 0:e.client_token,n=((a=this.paymentArgs)==null?void 0:a.mode)==="test"?"sandbox":"production";if(!t||typeof t!="string"||t.trim()===""){const s=this.$t("Paddle client token is missing or invalid.");throw new Error(s)}Paddle.Environment.set(n),Paddle.Initialize({token:t.trim(),eventCallback:s=>{this.handlePaddleEvent(s)}})}createPaddleButton(t){var r,d,i,c;const n=this,e=document.createElement("button");e.id="paddle-pay-button",e.className="paddle-checkout-button",e.innerHTML=((r=this.paymentArgs)==null?void 0:r.paddle_checkout_button_text)||this.$t("Pay with Paddle"),e.style.cssText=`
            width: 100%;
            padding: 12px 24px;
            background: ${((d=this.paymentArgs)==null?void 0:d.paddle_checkout_button_color)||"#1a73e8"};
            color: ${((i=this.paymentArgs)==null?void 0:i.paddle_checkout_button_text_color)||"#fff"};
            border: none;
            border-radius: 6px;
            font-size: ${((c=this.paymentArgs)==null?void 0:c.paddle_checkout_button_font_size)||"16px"};
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 10px;
        `,e.addEventListener("mouseenter",()=>{var o;e.style.backgroundColor=((o=this.paymentArgs)==null?void 0:o.paddle_checkout_button_hover_color)||"#1557b0"}),e.addEventListener("mouseleave",()=>{var o;e.style.backgroundColor=((o=this.paymentArgs)==null?void 0:o.paddle_checkout_button_color)||"#1a73e8"}),e.addEventListener("click",async o=>{o.preventDefault(),await n.handlePaddleButtonClick()}),t.appendChild(e);const a=document.createElement("p");a.style.cssText=`
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        `,a.textContent=this.$t("Secure payment powered by Paddle"),t.appendChild(a);const s=document.getElementById("fct_loading_payment_processor");s&&s.remove()}async handlePaddleButtonClick(){var t,n,e,a,s,r,d,i,c;try{if((t=this.paymentLoader)==null||t.changeLoaderStatus("processing"),typeof this.orderHandler=="function"){const o=await this.orderHandler();if(!o)throw(n=this.paymentLoader)==null||n.changeLoaderStatus(this.$t("Order creation failed")),(e=this.paymentLoader)==null||e.hideLoader(),this.paymentLoader.enableCheckoutButton(),new Error(this.$t("Failed to create order"));await this.openPaddleOverlay(o)}else throw(a=this.paymentLoader)==null||a.changeLoaderStatus(this.$t("Order handler not available")),(s=this.paymentLoader)==null||s.hideLoader(),(r=this.paymentLoader)==null||r.enableCheckoutButton(),new Error(this.$t("Order handler is not properly configured"))}catch(o){(d=this.paymentLoader)==null||d.changeLoaderStatus("Error: "+o.message),(i=this.paymentLoader)==null||i.hideLoader(),(c=this.paymentLoader)==null||c.enableCheckoutButton(),this.displayErrorMessage(document.querySelector(".fluent-cart-checkout_embed_payment_container_paddle"),o.message)}}async openPaddleOverlay(t){var n,e,a,s;try{this.currentOrderData=t;const r=(t==null?void 0:t.response)||t,d=(t==null?void 0:t.data)||{};let i=(r==null?void 0:r.paddle_price_ids)||[];if(!i||i.length===0)throw new Error(this.$t("No Paddle price IDs found in order data. Please ensure Paddle products are properly configured."));const c=i.map(l=>({priceId:l.price_id||l.priceId,quantity:parseInt(l.quantity)||1}));if(!c||c.length===0)throw new Error(this.$t("Failed to prepare valid Paddle items from order data."));const o={settings:{displayMode:"overlay",variant:"multi-page",theme:((n=this.intent)==null?void 0:n.theme)||"light",locale:((e=this.intent)==null?void 0:e.locale)||"en",showAddDiscounts:!1},items:c,customData:{fct_order_hash:((a=d==null?void 0:d.order)==null?void 0:a.hash)??"",fct_transaction_hash:((s=d==null?void 0:d.transaction)==null?void 0:s.hash)??""}};d!=null&&d.subscription&&(o.customData.fct_subscription_hash=d.subscription.hash??""),d!=null&&d.customer&&(o.customer=d.customer),r!=null&&r.paddle_discount_id&&(o.discountId=r==null?void 0:r.paddle_discount_id),this.paddleCheckout=Paddle.Checkout.open(o)}catch(r){throw console.error("Error opening Paddle overlay:",r),r}}handlePaddleEvent(t){var a;const n=t.name,e=t.data;switch(n){case"checkout.completed":this.handlePaddlePaymentSuccess(e);break;case"checkout.closed":this.handlePaddleCheckoutClosed(e);break;case"checkout.payment.initiated":(a=this.paymentLoader)==null||a.changeLoaderStatus("processing payment");break;case"checkout.payment.failed":this.handlePaddlePaymentFailed(e);break;case"checkout.items.updated":this.handlePaddleItemsUpdated(e);break;case"checkout.error":this.handlePaddleError(e);break;default:console.log("Unhandled Paddle event:",n,e)}}handlePaddleItemsUpdated(t){}async handlePaddlePaymentSuccess(t){var n,e,a,s;try{(n=this.paymentLoader)==null||n.changeLoaderStatus("confirming");const r=t==null?void 0:t.transaction_id,d=t==null?void 0:t.id;if(!r){(e=this.paymentLoader)==null||e.changeLoaderStatus(this.$t("Error: Missing transaction ID"));return}const i=t.custom_data,c=new URLSearchParams({action:"fluent_cart_confirm_paddle_payment",vendor_charge_id:r,checkout_id:d||"",fct_order_hash:i!=null&&i.fct_order_hash?i==null?void 0:i.fct_order_hash:"",fct_transaction_hash:i!=null&&i.fct_transaction_hash?i==null?void 0:i.fct_transaction_hash:"",totals:JSON.stringify(t.totals),total:(a=t.totals)==null?void 0:a.total}),o=new XMLHttpRequest;o.open("POST",window.fluentcart_checkout_vars.ajaxurl,!0),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.onload=()=>{var l,p,m,y,_;if(o.status>=200&&o.status<300)try{const h=JSON.parse(o.responseText);h!=null&&h.redirect_url?(this.paymentLoader.triggerPaymentCompleteEvent(h),(l=this.paymentLoader)==null||l.changeLoaderStatus("redirecting"),window.location.href=h.redirect_url):((p=this.paymentLoader)==null||p.changeLoaderStatus(this.$t("Confirmation failed")),(m=this.paymentLoader)==null||m.hideLoader())}catch(h){(y=this.paymentLoader)==null||y.changeLoaderStatus("Error: "+h.message)}else(_=this.paymentLoader)==null||_.changeLoaderStatus(this.$t("Confirmation failed"))},o.onerror=()=>{var l;(l=this.paymentLoader)==null||l.changeLoaderStatus(this.$t("Network error"))},o.send(c.toString())}catch(r){(s=this.paymentLoader)==null||s.changeLoaderStatus(this.$t("Error: %s",r.message))}}handlePaddleCheckoutClosed(t){var n,e,a;if(t.status==="completed")return this.handlePaddlePaymentSuccess(t);(n=this.paymentLoader)==null||n.changeLoaderStatus("canceled"),(e=this.paymentLoader)==null||e.hideLoader(),(a=this.paymentLoader)==null||a.enableCheckoutButton()}handlePaddlePaymentFailed(t){var e,a,s,r;(e=this.paymentLoader)==null||e.changeLoaderStatus(this.$t("Payment failed")),(a=this.paymentLoader)==null||a.hideLoader(),(s=this.paymentLoader)==null||s.enableCheckoutButton();const n=((r=t==null?void 0:t.error)==null?void 0:r.message)||this.$t("Payment failed");this.displayErrorMessage(document.querySelector(".fluent-cart-checkout_embed_payment_container_paddle"),n)}handlePaddleError(t){var e,a,s,r;(e=this.paymentLoader)==null||e.changeLoaderStatus(this.$t("Error occurred")),(a=this.paymentLoader)==null||a.hideLoader(),(s=this.paymentLoader)==null||s.enableCheckoutButton();const n=((r=t==null?void 0:t.error)==null?void 0:r.message)||this.$t("An error occurred. Please try again.");this.displayErrorMessage(document.querySelector(".fluent-cart-checkout_embed_payment_container_paddle"),n)}displayErrorMessage(t,n){const e=document.createElement("div");e.style.color="red",e.className="fc-error-message",e.textContent=n,t.appendChild(e)}}window.addEventListener("fluent_cart_load_payments_paddle",function(u){const t=document.querySelector(".fluent-cart-checkout_embed_payment_container_paddle");t&&(t.innerHTML='<div id="fct_loading_payment_processor">Loading Paddle...</div>'),fetch(u.detail.paymentInfoUrl,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":u.detail.nonce},credentials:"include"}).then(async e=>{e=await e.json(),new g(u.detail.form,u.detail.orderHandler,e,u.detail.paymentLoader).init()}).catch(e=>{var r;const a=((r=window.fct_paddle_data)==null?void 0:r.translations)||{};function s(d){return a[d]||d}n(s("An error occurred while loading Paddle."))});function n(e){const a=document.querySelector(".fluent-cart-checkout_embed_payment_container_paddle");a&&(a.innerHTML=`
            <div style="color: red; padding: 15px; border: 1px solid #ddd; border-radius: 4px; background: #ffeaea;">
                <strong>Error:</strong> ${e}
            </div>
        `)}});

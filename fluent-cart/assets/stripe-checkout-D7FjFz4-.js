class K{constructor(d,l,h){this.form=d,this.data=l,this.paymentArgs=l.payment_args,this.intent=l.intent,this.paymentLoader=h,this.$t=this.translate.bind(this)}translate(d){var h;return(((h=window.fct_stripe_data)==null?void 0:h.translations)||{})[d]||d}async init(){var x,L;const d=document.querySelector("[data-fluent-cart-checkout-page-checkout-button]"),l=document.querySelector(".fluent-cart-checkout_embed_payment_container_stripe"),h=this.form.querySelector(".fluent_cart_payment_methods");h&&(h.style.display="none");const o=this,a=Stripe((x=this.paymentArgs)==null?void 0:x.public_key),i=await a.elements(this.intent),u={fields:{billingDetails:{name:"never",email:"never"}}},c=await i.create("payment",u);c.mount(".fluent-cart-checkout_embed_payment_container_stripe");const r=(L=window.fluentcart_checkout_vars)==null?void 0:L.submit_button;c.on("loaderror",function(t){var g,e,k;const _=document.getElementById("fct_loading_payment_processor");_&&_.remove();let s=(g=t==null?void 0:t.error)==null?void 0:g.message,p="";if(((e=window==null?void 0:window.fluentcart_checkout_info)==null?void 0:e.is_admin)!=="1"){s=o.$t("Payment module not available to checkout! Please reload again, or contact admin!"),p=`<p style="color:red; display:none;" class="hidden-error">${(k=t==null?void 0:t.error)==null?void 0:k.message}</p>`;const f=document.createElement("a");f.className="toggle-error",f.style.cursor="pointer",f.textContent=o.$t("See Errors"),f.addEventListener("click",function(){document.querySelector(".hidden-error").style.display=document.querySelector(".hidden-error").style.display==="none"?"block":"none"}),l.prepend(f)}const n=document.createElement("p");n.style.color="red",n.innerHTML=s+p,l.prepend(n),window.is_stripe_ready=!1,o.paymentLoader.disableCheckoutButton(r==null?void 0:r.text)}),c.on("ready",function(t){const _=document.getElementById("fct_loading_payment_processor");if(_&&_.remove(),d&&d.id==="fluent_cart_custom_checkout_btn")o.paymentLoader.disableCheckoutButton(o.$t("Pay Now"));else{const s=o.form.querySelector('input[name="_fct_pay_method"]:checked');s&&s.value==="stripe"&&o.paymentLoader.disableCheckoutButton(r.text)}window.is_stripe_ready=!1,c.addEventListener("change",function(s){window.is_stripe_ready=s.complete,document.querySelectorAll(".fc-error-message").forEach(n=>n.remove()),window.is_stripe_ready?d&&d.id==="fluent_cart_custom_checkout_btn"?o.paymentLoader.enableCheckoutButton(o.$t("Pay Now")):o.paymentLoader.enableCheckoutButton(r.text):o.paymentLoader.disableCheckoutButton(r!=null&&r.text?r.text:o.$t("Place Order"))}),window.addEventListener("fluent_cart_payment_next_action_stripe",s=>{var M,$,T,N,I,B,A,O,D,U,j;(M=o.paymentLoader)==null||M.changeLoaderStatus("processing");const p=document.querySelector(".fc-loader");($=p==null?void 0:p.classList)==null||$.add("active");const n=(T=s.detail)==null?void 0:T.response;let g=(N=n==null?void 0:n.payment_args)==null?void 0:N.success_url;(I=n==null?void 0:n.payment_args)==null||I.custom_payment_url;const e=n==null?void 0:n.fc_customer;let k=null,f="intent";((B=n==null?void 0:n.response)==null?void 0:B.object)==="subscription"?(f=(O=(A=n==null?void 0:n.payment_args)==null?void 0:A.vendor_subscription_info)==null?void 0:O.type,k=(U=(D=n==null?void 0:n.payment_args)==null?void 0:D.vendor_subscription_info)==null?void 0:U.clientSecret):k=(j=n==null?void 0:n.response)==null?void 0:j.client_secret;const C=function(q){const w=document.createElement("div");w.className="fc-error-message",w.textContent=q,l.appendChild(w),new Toastify({text:`<span class="warn warning">${q}</span>`,className:"warning",escapeMarkup:!1,duration:3e3,close:!0,style:{color:"#000",background:"#ffffff",maxWidth:"300px"}}).showToast()};i.submit().then(q=>{const w=f==="setup"?a.confirmSetup:a.confirmPayment,v=f==="setup"?"setupIntent":"paymentIntent",z={elements:i,clientSecret:k,confirmParams:{return_url:g,payment_method_data:{billing_details:{address:{city:e!=null&&e.city?e==null?void 0:e.city:null,country:e!=null&&e.country?e==null?void 0:e.country:null,postal_code:e!=null&&e.postcode?e==null?void 0:e.postcode:null,state:e!=null&&e.state?e==null?void 0:e.state:null,line1:e!=null&&e.address_1?e==null?void 0:e.address_1:null},name:(e==null?void 0:e.first_name)+" "+(e==null?void 0:e.last_name),email:e==null?void 0:e.email}}},redirect:"if_required"};w(z).then(S=>{var H,Q,J,W;(H=o.paymentLoader)==null||H.changeLoaderStatus("confirming"),S!=null&&S.error&&(o.paymentLoader.enableCheckoutButton(r.text),C((Q=S.error)==null?void 0:Q.message),(J=o.paymentLoader)==null||J.hideLoader());const y=S[v];if(y!=null&&y.status&&(y.status==="succeeded"||y.status==="processing"||y.status==="requires_capture")){(W=o.paymentLoader)==null||W.changeLoaderStatus("completed");const F=new URLSearchParams(window.location.search).get("mode")||"order",G=new URLSearchParams({action:"fluent_cart_confirm_stripe_payment",intentId:y.id,mode:F}).toString(),m=new XMLHttpRequest;m.open("POST",window.fluentcart_checkout_vars.ajaxurl,!0),m.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),m.onreadystatechange=function(){var X;if(m.readyState===4)if(m.status>=200&&m.status<300){(X=o.paymentLoader)==null||X.changeLoaderStatus("redirecting");let E=JSON.parse(m.responseText);E&&(o.paymentLoader.triggerPaymentCompleteEvent(E),E.redirect_url&&(g=E.redirect_url)),window.location.href=g}else console.log(m.responseText,"failed")},m.onerror=function(){console.log("Request failed")},m.send(G)}else if(y.status==="requires_action"||y.status==="requires_source_action")return P(y)})}).catch(q=>{var w,v;console.log(q,"failed"),p.classList.remove("active"),(w=o.paymentLoader)==null||w.changeLoaderStatus("failed"),(v=o.paymentLoader)==null||v.hideLoader()})})});const P=t=>{var s,p;(s=o.paymentLoader)==null||s.changeLoaderStatus(o.$t("redirecting for action"));const _=(p=t.next_action)==null?void 0:p.type;switch(_){case"redirect_to_url":window.location.href=t.next_action.redirect_to_url.url;break;case"cashapp_handle_redirect_or_display_qr_code":t.next_action.cashapp_handle_redirect_or_display_qr_code.hosted_instructions_url?window.location.href=t.next_action.cashapp_handle_redirect_or_display_qr_code.hosted_instructions_url:console.log("QR Code:",t.next_action.cashapp_handle_redirect_or_display_qr_code.qr_code);break;case"display_boleto":window.location.href=t.next_action.boleto_display_details.hosted_voucher_url;break;case"oxxo_display_details":window.location.href=t.next_action.oxxo_display_details.hosted_voucher_url;break;case"alipay_handle_redirect":window.location.href=t.next_action.alipay_handle_redirect.url;break;case"konbini_display_details":window.location.href=t.next_action.konbini_display_details.hosted_voucher_url;break;case"display_bank_transfer_instructions":window.location.href=t.next_action.display_bank_transfer_instructions.hosted_instructions_url;break;case"verify_with_microdeposits":window.location.href=t.next_action.verify_with_microdeposits.hosted_verification_url;break;case"wechat_pay_display_qr_code":t.next_action.wechat_pay_display_qr_code.hosted_instructions_url?window.location.href=t.next_action.wechat_pay_display_qr_code.hosted_instructions_url:console.log("QR Code:",t.next_action.wechat_pay_display_qr_code.qr_code);break;case"promptpay_display_qr_code":t.next_action.promptpay_display_qr_code.hosted_instructions_url?window.location.href=t.next_action.promptpay_display_qr_code.hosted_instructions_url:console.log("QR Code:",t.next_action.promptpay_display_qr_code.qr_code);break;default:console.error("Unsupported next_action type:",_);break}};window.addEventListener("fluent_cart_validate_checkout_stripe",function(t){if(!window.is_stripe_ready){const _=document.createElement("div");_.className="fc-error-message",_.textContent=o.$t("Card details are not valid!"),document.querySelector(".fluent-cart-checkout-page-checkout-form-order-summary").appendChild(_),a.confirmPayment({elements:i,confirmParams:{return_url:"https://stripe.com"},redirect:"if_required"})}})}}window.addEventListener("fluent_cart_load_payments_stripe",function(b){window.fluentcart.$t;const d=document.querySelector(".fluent-cart-checkout_embed_payment_container_stripe");o(),h(),fetch(b.detail.paymentInfoUrl,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":b.detail.nonce},credentials:"include"}).then(async a=>{var u,c,r;if(a=await a.json(),(a==null?void 0:a.status)==="failed"&&l(a==null?void 0:a.message),((u=a==null?void 0:a.intent)==null?void 0:u.amount)<=0&&((c=a==null?void 0:a.intent)==null?void 0:c.mode)!=="subscription"){let x=function(t){return P[t]||t};var i=x;const P=((r=window.fct_stripe_data)==null?void 0:r.translations)||{};l(x("Total amount is not valid, please add some items to cart!"));const L=document.getElementById("fct_loading_payment_processor");L&&L.remove();return}new K(b.detail.form,a,b.detail.paymentLoader).init()}).catch(a=>{var c;const i=((c=window.fct_stripe_data)==null?void 0:c.translations)||{};function u(r){return i[r]||r}l(u("An error occurred while parsing the response."))});function l(a){const i=document.createElement("div");i.className="fc-error-message",i.textContent=a,d.appendChild(i);const u=document.getElementById("fct_loading_payment_processor");u&&u.remove()}function h(){var c;const a=document.createElement("p");a.id="fct_loading_payment_processor";const i=((c=window.fct_stripe_data)==null?void 0:c.translations)||{};function u(r){return i[r]||r}a.textContent=u("Loading Payment Processor..."),d.appendChild(a)}function o(){document.querySelectorAll(".fc-error-message").forEach(i=>i.remove())}});
